<!DOCTYPE html>
<html>
    <head>
        <title>WebSocket client</title>
    </head>
    <body>
        <div id="qrcode"></div>
        <button id="button" type="button">Click to Reload the QR Code!</button>
        <h1 id="success">Successfully Connected!</h1>
        <script src="./vendor/qrcode.js"></script>
        <script>
            var qrCodeElem = document.getElementById("qrcode");
            var qrCode = new QRCode(qrCodeElem);
            var button = document.getElementById("button");
            var success = document.getElementById("success");

            function startWebSocket(){
                const pingTimeout = 5000;
                const pingInterval = 10000;
                var websocket = new WebSocket("ws://0.0.0.0:8080/websocket");

                button.style.display = "none";
                success.style.display = "none";

                console.log("Sending Token From Client");

                function ping() {
                    if (websocket.readyState === WebSocket.OPEN) {
                        websocket.send(JSON.stringify({msg: "__ping__"}));
                        tm = setTimeout(function () {
                            console.log("I'm closing the Websocket from client side");
                            websocket.close();
                        }, pingTimeout);
                    }
                }
                function pong() {
                    clearTimeout(tm);
                }

                websocket.addEventListener('open', function (event) {
                    websocket.send(JSON.stringify({msg: "Hey! Here is a Token", token: "im-a-fake-token"}));
                });
                websocket.onopen = function () {
                    setInterval(ping, pingInterval);
                }
                websocket.onmessage = function (event) {
                    var data = JSON.parse(event.data);
                    switch (data.type) {
                        case 'pong':
                            pong();
                            break;
                        case 'code':
                            qrCode.makeCode(data.key);
                            qrCodeElem.style.display = "initial";
                            console.log("http://0.0.0.0:8080/connection/" + data.key);
                            console.log(data.msg);
                            break;
                        case 'success':
                            qrCodeElem.style.display = "none";
                            success.style.display = "initial";
                            break;
                        case 'timeout':
                            qrCodeElem.style.display = "none";
                            button.style.display = "initial";
                            break;
                        default:
                            console.error("unsupported event", data);
                    }
                };
                websocket.onclose = function (event) {
                    console.log("Server said Bye!");
                };
            }

            startWebSocket();
            button.onclick = function (event) {
                startWebSocket();
                button.style.display = "none";
            }
        </script>
    </body>
</html>